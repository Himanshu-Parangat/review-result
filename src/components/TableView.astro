---

const scope: 'col' | 'row' = "col"; 

type TableProps = {

	tableCaption: string
	tableHeader: string[]
	tableFooter: string[]

}

const { tableCaption, tableHeader, tableFooter} = Astro.props as TableProps 

---


<div class="flex flex-col w-full">
	<!-- Options bar -->
	<div class="flex flex-row justify-between w-full p-2 gap-2"> 

		<div class="flex flex-row flex-wrap gap-2">

			<button 
				class="flex flex-row bg-tertiary hover-overlay active-overlay px-2 py-1 border-2 border-primary rounded-lg items-center justify-center"
					onclick="const SearchMenu = document.getElementById('SearchMenu')
					if(SearchMenu){ SearchMenu.style.display = SearchMenu.style.display === 'none' ? 'flex' : 'none';}"
			>
				<svg xmlns="http://www.w3.org/2000/svg" 
					class="shrink-0 w-5 h-5 text-primary mr-2" 
					fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path d="M14.9536 14.9458L21 21M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
				</svg><span>Search</span>
			</button>

			<button 
				class="flex flex-row bg-tertiary hover-overlay active-overlay px-2 py-1 border-2 border-primary rounded-lg items-center justify-center"
				onclick="const filterMenu = document.getElementById('filterMenu')
				if(filterMenu){ filterMenu.style.display = filterMenu.style.display === 'none' ? 'flex' : 'none';}">
					<svg xmlns="http://www.w3.org/2000/svg" 
						class="shrink-0 w-5 h-5 text-primary mr-2" 
						fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<!-- <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"  -->
						<!-- 		d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /> -->
						<!-- <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"  -->
						<!-- 		d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /> -->
						<path fill-rule="evenodd" clip-rule="evenodd" d="M4.95301 2.25C4.96862 2.25 4.98429 2.25 5.00001 2.25L19.047 2.25C19.7139 2.24997 20.2841 2.24994 20.7398 2.30742C21.2231 2.36839 21.6902 2.50529 22.0738 2.86524C22.4643 3.23154 22.6194 3.68856 22.6875 4.16405C22.7501 4.60084 22.7501 5.14397 22.75 5.76358L22.75 6.54012C22.75 7.02863 22.75 7.45095 22.7136 7.80311C22.6743 8.18206 22.5885 8.5376 22.3825 8.87893C22.1781 9.2177 21.9028 9.4636 21.5854 9.68404C21.2865 9.8917 20.9045 10.1067 20.4553 10.3596L17.5129 12.0159C16.8431 12.393 16.6099 12.5288 16.4542 12.6639C16.0966 12.9744 15.8918 13.3188 15.7956 13.7504C15.7545 13.9349 15.75 14.1672 15.75 14.8729L15.75 17.605C15.7501 18.5062 15.7501 19.2714 15.6574 19.8596C15.5587 20.4851 15.3298 21.0849 14.7298 21.4602C14.1434 21.827 13.4975 21.7933 12.8698 21.6442C12.2653 21.5007 11.5203 21.2094 10.6264 20.8599L10.5395 20.826C10.1208 20.6623 9.75411 20.519 9.46385 20.3691C9.1519 20.208 8.8622 20.0076 8.64055 19.6957C8.41641 19.3803 8.32655 19.042 8.28648 18.6963C8.24994 18.381 8.24997 18.0026 8.25 17.5806L8.25 14.8729C8.25 14.1672 8.24555 13.9349 8.20442 13.7504C8.1082 13.3188 7.90342 12.9744 7.54584 12.6639C7.39014 12.5288 7.15692 12.393 6.48714 12.0159L3.54471 10.3596C3.09549 10.1067 2.71353 9.8917 2.41458 9.68404C2.09724 9.4636 1.82191 9.2177 1.61747 8.87893C1.41148 8.5376 1.32571 8.18206 1.28645 7.80311C1.24996 7.45094 1.24998 7.02863 1.25 6.54012L1.25001 5.81466C1.25001 5.79757 1.25 5.78054 1.25 5.76357C1.24996 5.14396 1.24991 4.60084 1.31251 4.16405C1.38064 3.68856 1.53576 3.23154 1.92618 2.86524C2.30983 2.50529 2.77695 2.36839 3.26024 2.30742C3.71592 2.24994 4.28607 2.24997 4.95301 2.25ZM3.44796 3.79563C3.1143 3.83772 3.0082 3.90691 2.95251 3.95916C2.90359 4.00505 2.83904 4.08585 2.79734 4.37683C2.75181 4.69454 2.75001 5.12868 2.75001 5.81466V6.50448C2.75001 7.03869 2.75093 7.38278 2.77846 7.64854C2.8041 7.89605 2.84813 8.01507 2.90174 8.10391C2.9569 8.19532 3.0485 8.298 3.27034 8.45209C3.50406 8.61444 3.82336 8.79508 4.30993 9.06899L7.22296 10.7088C7.25024 10.7242 7.2771 10.7393 7.30357 10.7542C7.86227 11.0685 8.24278 11.2826 8.5292 11.5312C9.12056 12.0446 9.49997 12.6682 9.66847 13.424C9.75036 13.7913 9.75022 14.2031 9.75002 14.7845C9.75002 14.8135 9.75 14.843 9.75 14.8729V17.5424C9.75 18.0146 9.75117 18.305 9.77651 18.5236C9.79942 18.7213 9.83552 18.7878 9.8633 18.8269C9.89359 18.8695 9.95357 18.9338 10.152 19.0363C10.3644 19.146 10.6571 19.2614 11.1192 19.442C12.0802 19.8177 12.7266 20.0685 13.2164 20.1848C13.695 20.2985 13.8527 20.2396 13.9343 20.1885C14.0023 20.146 14.1073 20.0597 14.1757 19.626C14.2478 19.1686 14.25 18.5234 14.25 17.5424V14.8729C14.25 14.843 14.25 14.8135 14.25 14.7845C14.2498 14.2031 14.2496 13.7913 14.3315 13.424C14.5 12.6682 14.8794 12.0446 15.4708 11.5312C15.7572 11.2826 16.1377 11.0685 16.6964 10.7542C16.7229 10.7393 16.7498 10.7242 16.7771 10.7088L19.6901 9.06899C20.1767 8.79508 20.496 8.61444 20.7297 8.45209C20.9515 8.298 21.0431 8.19532 21.0983 8.10391C21.1519 8.01507 21.1959 7.89605 21.2215 7.64854C21.2491 7.38278 21.25 7.03869 21.25 6.50448V5.81466C21.25 5.12868 21.2482 4.69454 21.2027 4.37683C21.161 4.08585 21.0964 4.00505 21.0475 3.95916C20.9918 3.90691 20.8857 3.83772 20.5521 3.79563C20.2015 3.75141 19.727 3.75 19 3.75H5.00001C4.27297 3.75 3.79854 3.75141 3.44796 3.79563Z" fill="currentColor"/>
					</svg><span> Filter </span>
			</button>

		</div>

		<div class="flex flex-row flex-wrap gap-2">
			<button class="flex flex-row bg-tertiary hover-overlay active-overlay px-2 py-1 border-2 border-primary rounded-lg items-center justify-center">
				<svg xmlns="http://www.w3.org/2000/svg" 
					 class="shrink-0 w-5 h-5 text-primary mr-2" 
					 fill="currentColor" 
					 viewBox="0 0 24 24">
					<path d="M13 3a1 1 0 1 0-2 0v8.586l-1.293-1.293a1 1 0 0 0-1.414 1.414l3 3a1 1 0 0 0 1.414 0l3-3a1 1 0 0 0-1.414-1.414L13 11.586V3z"/>
					<path d="M6 8a4 4 0 0 0-4 4v6a4 4 0 0 0 4 4h11a5 5 0 0 0 5-5v-5a4 4 0 0 0-4-4 1 1 0 1 0 0 2 2 2 0 0 1 2 2v5a3 3 0 0 1-3 3H6a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2 1 1 0 0 0 0-2z"/>
				</svg><span> Export </span>
			</button>

			<button class="flex flex-row bg-tertiary hover-overlay active-overlay px-2 py-1 border-2 border-primary rounded-lg items-center justify-center">
				<svg fill="currentColor" class="shrink-0 w-5 h-5" viewBox="0 0 32 32" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg">
					<defs>
						<style>
							.cls-1 {
								fill: none;
							}
						</style>
					</defs>
					<rect x="2" y="18" width="4" height="2"/>
					<rect x="26" y="18" width="4" height="2"/>
					<path d="M24,22v6H8V22H6v6a2.0058,2.0058,0,0,0,2,2H24a2.0058,2.0058,0,0,0,2-2V22Z" transform="translate(0 0)"/>
					<path d="M8,16V4h8v6a2.0058,2.0058,0,0,0,2,2h6v4h2V10a.9092.9092,0,0,0-.3-.7l-7-7A.9087.9087,0,0,0,18,2H8A2.0058,2.0058,0,0,0,6,4V16ZM18,4.4,23.6,10H18Z" transform="translate(0 0)"/>
					<rect x="10" y="18" width="4" height="2"/>
					<rect x="18" y="18" width="4" height="2"/>
					<rect id="_Transparent_Rectangle_" data-name="&lt;Transparent Rectangle&gt;" class="cls-1" width="32" height="32"/>
				</svg><span class="ml-1">Page</span>
			</button>

		</div>

	</div>

	<!-- Filter bar -->
	<div id="filterMenu" class="flex flex-row flex-wrap w-full p-2 gap-2" style="display: none;">

		{tableHeader.map((tableHead,index) => (
			<div class=" flex flex-row flex-wrap gap-2 border-2 border-primary py-1 px-3 rounded-lg">
				<label class="flex flex-row justify-between items-center gap-2 whitespace-nowrap">
				<input type="checkbox" class="scale-180 column-toggle whitespace-nowrap" data-column-index={index} checked>
						{tableHead}
				</label>
			</div>

		))}


	</div>

	<!-- Search menu bar  -->
	<div id="SearchMenu" class="flex flex-row w-full p-2 gap-2" style="display: none;">
		<input
			type="text"
			id="SearchMenuBar"
			name="SearchMenu"
			class="w-full my-2 py-1 px-2 border-2 border-primary rounded-lg bg-tertiary focus:ring-2 focus:ring-accent focus:outline-none text-lg text-secondary placeholder:text-muted"
			placeholder="Search By Row Data..." />
	</div>

	<!-- Table with Heading -->
	<div class="w-full h-auto overflow-auto">
		<table id="dataTable" class=" border-separate border-spacing-0 border border-primary rounded-b-lg">
			{tableCaption && (
				<caption class="border border-primary rounded-t-lg bg-tertiary font-bold whitespace-nowrap px-2">{tableCaption}</caption>
			)}
			<thead class="bg-tertiary rounded-t-lg">
				<tr class="hover-overlay">

					{tableHeader.map((tableHead,index) => (
						<th class="group border border-primary cursor-pointer select-none" 
								data-sort="normal" 
								data-column-index={index}
								data-content={tableHead}
								scope={scope}>
								
								<button class="flex flex-row items-center gap-2 active-overlay px-4 py-1 font-bold whitespace-nowrap w-full ">
									<span>{tableHead}</span>
										
										<svg xmlns="http://www.w3.org/2000/svg" 
												 class="hidden group-data-[sort=descending]:block shrink-0 w-5 h-5 text-primary" 
												 fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path fill-rule="evenodd" clip-rule="evenodd" d="M17 3.25C17.4142 3.25 17.75 3.58579 17.75 4V17.75L19.4 15.55C19.6485 15.2186 20.1186 15.1515 20.45 15.4C20.7814 15.6485 20.8485 16.1186 20.6 16.45L17.6 20.45C17.4063 20.7083 17.0691 20.8136 16.7628 20.7115C16.4566 20.6094 16.25 20.3228 16.25 20V4C16.25 3.58579 16.5858 3.25 17 3.25ZM7.25 6C7.25 5.58579 7.58579 5.25 8 5.25H13C13.4142 5.25 13.75 5.58579 13.75 6C13.75 6.41421 13.4142 6.75 13 6.75H8C7.58579 6.75 7.25 6.41421 7.25 6ZM5.25 11C5.25 10.5858 5.58579 10.25 6 10.25H13C13.4142 10.25 13.75 10.5858 13.75 11C13.75 11.4142 13.4142 11.75 13 11.75H6C5.58579 11.75 5.25 11.4142 5.25 11ZM3.25 16C3.25 15.5858 3.58579 15.25 4 15.25H13C13.4142 15.25 13.75 15.5858 13.75 16C13.75 16.4142 13.4142 16.75 13 16.75H4C3.58579 16.75 3.25 16.4142 3.25 16Z" fill="currentColor"/>
										</svg>

										<svg xmlns="http://www.w3.org/2000/svg" 
												 class="hidden group-data-[sort=ascending]:block shrink-0 w-5 h-5 text-primary" 
												 fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path fill-rule="evenodd" clip-rule="evenodd" d="M16.7628 3.28854C17.0691 3.18645 17.4063 3.29179 17.6 3.55005L20.6 7.55005C20.8485 7.88142 20.7814 8.35152 20.45 8.60005C20.1186 8.84858 19.6485 8.78142 19.4 8.45005L17.75 6.25005V20C17.75 20.4143 17.4142 20.75 17 20.75C16.5858 20.75 16.25 20.4143 16.25 20V4.00005C16.25 3.67723 16.4566 3.39062 16.7628 3.28854ZM13 8.75005H4V7.25005H13V8.75005ZM13 13.75H6V12.25H13V13.75ZM13 18.75H8V17.25H13V18.75Z" fill="currentColor"/>
										</svg>
								</button>
						</th>
					))}
				</tr>
			</thead>

			<tbody class="border-2 scoped-table-body">
				<slot></slot>
			</tbody>

			<tfoot class="bg-tertiary">
				<tr class="hover-overlay h-6">
					{tableFooter.map((tableFoot,index) => (
					<td class="px-4 py-1 font-bold whitespace-nowrap" data-column-index={index} data-content={tableFoot}>{tableFoot}</td>
					))
					}
				</tr>
			</tfoot>
		</table>

	</div>
</div>

<script>
    const table = document.getElementById("dataTable") as HTMLTableElement;

    if (table) {
			function ToggleColumn() {
				document.querySelectorAll<HTMLInputElement>(".column-toggle")
					.forEach(checkbox => {
						checkbox.addEventListener("change", () => {
							const columnIndexNumber = Number(checkbox.dataset.columnIndex);
							const rows = table.rows;

							for (const row of rows) {
								const cell = row.cells[columnIndexNumber];
								if (cell) { cell.style.display = checkbox.checked ? "" : "none"; }
							}
						});
					});
			}

			ToggleColumn();

        // 2. Fuzzy Match Logic
        const fuzzyMatch = (text: string, query: string): boolean => {
					const finalIndex = text.split('').reduce((queryIndex, Character) => {
						return (queryIndex < query.length && Character === query[queryIndex])
							? queryIndex + 1
							: queryIndex;
					}, 0);

					return finalIndex === query.length;
        };

        function highlightMatch(text: string, query: string): string {
					if (!query) return text;

					const chars = text.split("");
					const queryChars = query.toLowerCase().split("");
					let queryIdx = 0;

					const highlighted = chars.map(char => {
						if (queryIdx < queryChars.length && char.toLowerCase() === queryChars[queryIdx]) {
							queryIdx++;
							return `<mark class="status-indicator-accent underline font-semibold">${char}</mark>`;
						}
						return char;
					});

					return highlighted.join("");
        }

        function seachTableByRow() {
            const searchInput = document.getElementById("SearchMenuBar") as HTMLInputElement;
            if (!searchInput) return;

            const tableBody = table.tBodies[0];
            const rows = Array.from(tableBody.rows);

            const rowCache = rows.map(row => {
                return {
                    element: row,
                    cells: Array.from(row.cells).map(cell => ({
											element: cell,
											content: cell.getAttribute('data-content') || "",
											ignore: cell.dataset.ignoreHighlight === "true"
                    }))
                };
            });

            searchInput.addEventListener("input", () => {
                const query = searchInput.value.trim().toLowerCase();

                rowCache.forEach(rowItem => {
                    let rowMatches = false;

                    rowItem.cells.forEach(cellItem => {
                        const text = cellItem.content;
                        
                        if (query === "") {
													cellItem.element.textContent = text;
													rowMatches = true;
                        } else if (fuzzyMatch(text.toLowerCase(), query)) {
													cellItem.element.innerHTML = highlightMatch(text, query);
													rowMatches = true; 
                        } else {
													cellItem.element.textContent = text;
                        }
                    });

                    rowItem.element.style.display = rowMatches ? "" : "none";
                });
            });
        }

        seachTableByRow();


				const tableBody = table.tBodies[0];
				const originalRows = Array.from(tableBody.rows);

				function handleSort() {
					const headers = table.querySelectorAll('th[data-sort]');

					headers.forEach((header, index) => {
						header.addEventListener("click", () => {
							const currentStatus = header.getAttribute("data-sort");
							let newStatus: "ascending" | "descending" | "normal";

							if (currentStatus === "normal") newStatus = "ascending";
							else if (currentStatus === "ascending") newStatus = "descending";
							else newStatus = "normal";

							headers.forEach(h => h.setAttribute("data-sort", "normal"));
							header.setAttribute("data-sort", newStatus);

							let rowsToSort = Array.from(tableBody.rows);

							if (newStatus === "normal") {
									tableBody.append(...originalRows);
									return;
							}

							rowsToSort.sort((a, b) => {
								const cellA = a.cells[index];
								const cellB = b.cells[index];
								
								const valA = cellA.getAttribute("data-content") || "";
								const valB = cellB.getAttribute("data-content") || "";
								const type = cellA.getAttribute("data-type");

								if (type === "number") {
										return newStatus === "ascending" ? Number(valA) - Number(valB) : Number(valB) - Number(valA);
								}
								
								if (type === "date") {
										return newStatus === "ascending" 
												? new Date(valA).getTime() - new Date(valB).getTime() 
												: new Date(valB).getTime() - new Date(valA).getTime();
								}

								return newStatus === "ascending" 
										? valA.localeCompare(valB) 
										: valB.localeCompare(valA);
							});

							tableBody.append(...rowsToSort);
						});
					});
				}

				handleSort();
    }
</script>
