---
export const prerender =	false;
import BaseLayout from "@layouts/BaseLayout.astro"
import ScheduleEntry from "@components/ScheduleEntry.astro";
import { db, siteSchema } from "@db/index";
import { eq } from "drizzle-orm";




const GetAllEvents = function () {
	const identity = db
		.select({ dbId: siteSchema.dbIdentity.dbId })
		.from(siteSchema.dbIdentity)
		.limit(1)
		.get();

	if (!identity?.dbId) return [];

	const events = db
		.select()
		.from(siteSchema.event)
		.where(eq(siteSchema.event.dbId, identity.dbId))
		.all();

	return events;
};

const Events = GetAllEvents()

---

<BaseLayout class="Schedule">
  <div class="mx-[5%] h-full flex flex-col items-center">
    <div class="flex lg:flex-row flex-col gap-4 w-full h-full">

      <!-- Schedule panel: fixed size -->
      <div class="border-2 border-primary rounded-lg min-w-[28%] shrink-0 min-h-0 flex flex-col p-4">
				<h1 class="text-xl font-bold text-center pb-3 mb-2 border-b-2 border-primary">Schedule Event</h1>
					<form method="post" class=" flex-1 space-y-6 overflow-y-auto p-4">

					<div class="">
						<h3 class="text-lg font-semibold mb-2">Event Title</h3>
						<input
							type="text"
							name="eventTitle"
							class="w-full p-3 border-2 border-primary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
							placeholder="Type your title here..." />

					</div>

					<div class="">
						<h3 class="text-lg font-semibold mb-2">Event Description</h3>

						<textarea 
							name="eventDescription"
							rows="4"
							class="w-full p-3 border-2 border-primary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
							placeholder="Type your answer here..."></textarea>

					</div>


					<div class="">
						<h3 class="text-lg font-semibold mb-2">Event Start</h3>

						<input
							type="datetime-local"
							name="eventScheduledStartAt"
							class="w-full p-3 border-2 border-primary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
							placeholder="Type your title here..." />

					</div>


					<div class="">
						<h3 class="text-lg font-semibold mb-2">Event End</h3>

						<input
							type="datetime-local"
							name="eventScheduledEndAt"
							class="w-full p-3 border-2 border-primary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
							placeholder="Type your title here..." />

					</div>

					<button
						type="submit"
						class="w-full p-3 rounded-lg bg-accent text-white font-semibold hover:opacity-90 transition"
					>
						Schedule
					</button>

					</form>

      </div>

      <!-- Entry panel: grows and becomes scrollable -->
      <div class="border-2 border-primary rounded-lg flex-1 flex">
				<div class="flex-1 lg:flex lg:flex-col  min-h-0 w-full  shrink-0 p-4 ">
					<h1 class="text-xl font-bold text-center pb-3 mb-2 border-b-2 border-primary">Scheduled Entry</h1>

          <!-- Scrollable list -->
					<div class="overflow-y-auto p-4">
						<div class="p-2 space-y-2 ">

							<!-- new event -->

							<!-- <ScheduleEntry -->
							<!-- 	number="1" -->
							<!-- 	title="Test Event" -->
							<!-- 	description="this is a test event, for showing a an entry" -->
							<!-- 	startIn="2025-11-27T17:58" -->
							<!-- 	endIn="2025-11-27T18:58:44" -->
							<!-- /> -->

							{Events.map((entry, index) => 
								<ScheduleEntry
									entryId={entry.eventId}
									number={index + 1}
									title={entry.eventTitle}
									description={entry.eventDescription}
									startIn={entry.eventScheduledStartAt}
									endIn={entry.eventScheduledEndAt}
								/>
							)}

						</div>

					</div>

        </div>
      </div>

    </div>
  </div>

		<script is:inline>
  (function() {
    function formatTimeParts(diff) {
      const absDiff = Math.abs(diff);
      const days = Math.floor(absDiff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((absDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((absDiff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((absDiff % (1000 * 60)) / 1000);
      
      if (days > 0) {
        return `${days}d ${hours}h`;
      } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    function updateTimestamp(element) {
      const startDate = new Date(element.dataset.start).getTime();
      const endDate = new Date(element.dataset.end).getTime();
      const eventName = element.dataset.event || "Event";
      const now = new Date().getTime();
      const diffToStart = startDate - now;
      const diffToEnd = endDate - now;
      
      if (diffToStart > 60000) {
        element.textContent = `Starts in ${formatTimeParts(diffToStart)}`;
      } else if (diffToStart > 0 && diffToStart <= 60000) {
        element.textContent = `Starting now!`;
      } else if (diffToEnd > 60000) {
        element.textContent = `Ongoing (${formatTimeParts(diffToEnd)} left)`;
      } else if (diffToEnd > 0 && diffToEnd <= 60000) {
        element.textContent = `Ending now!`;
      } else {
        element.textContent = `Ended ${formatTimeParts(diffToEnd)} ago`;
      }
    }
    
    function initTimestamps() {
      const timestamps = document.querySelectorAll('.countdown-timestamp');
      
      timestamps.forEach(element => {
        updateTimestamp(element);
        
        const scheduleEntry = element.closest('.p-4.border-2.border-primary');
        
        if (scheduleEntry) {
          let intervalId = null;
          

          scheduleEntry.addEventListener('mouseenter', () => {
            updateTimestamp(element); // Update immediately
            intervalId = setInterval(() => updateTimestamp(element), 1000);
          });
          

          scheduleEntry.addEventListener('mouseleave', () => {
            if (intervalId) {
              clearInterval(intervalId);
              intervalId = null;
            }
          });
        }
      });
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTimestamps);
    } else {
      initTimestamps();
    }
    
    document.addEventListener('astro:page-load', initTimestamps);
  })();
</script>
</BaseLayout>
