---
export const prerender = false
import { getDb, siteSchema } from "@db/index";
import { eq, isNull, and } from "drizzle-orm";
import EventWaitRoom from "@components/EventWaitRoom.astro";
import EventLiveRoom from "@components/EventLiveRoom.astro";
import EventClosedRoom from "@components/EventClosedRoom.astro";

const db = getDb()
const { eventId } = Astro.params;

let event = null;

if (!eventId) {
	return Astro.redirect("/");
}

const GetAllQuizes = await db.query.question.findMany({
	where:(and(
		eq(siteSchema.question.eventId, eventId),
		isNull(siteSchema.question.questionDeletedAt)
	)),
  with: {
    options: true
  }
});


try {
	event = db
		.select()
		.from(siteSchema.event)
		.where(and(
			eq(siteSchema.event.eventId, eventId),
			isNull(siteSchema.event.eventDeletedAt)
		))
		.get();
	
	if (!event) {
		return Astro.redirect("/");
	}
} catch (error) {
	console.error("Database error:", error);
	return Astro.redirect("/");
}

type EventState = "WAITING" | "LIVE" | "ENDED";

let eventState: EventState;

const now = new Date();
const scheduledStart = new Date(event.eventScheduledStartAt!);
const scheduledEnd = new Date(event.eventScheduledEndAt!);

if (now < scheduledStart) {
	eventState = "WAITING";
} else if (now >= scheduledStart && now < scheduledEnd) {
	eventState = "LIVE";
} else {
	eventState = "ENDED";
}

---

{eventState === "WAITING" && (
	<EventWaitRoom
		Id={event.eventId}
		Title={event.eventTitle}
		Description={event.eventDescription}
		StartAt={event.eventScheduledStartAt}
		EndAt={event.eventScheduledEndAt}
	/>
)}


{eventState === "LIVE" && (
	<EventLiveRoom
		id={event.eventId}
		title={event.eventTitle}
		description={event.eventDescription}
		startAt={event.eventScheduledStartAt}
		endAt={event.eventScheduledEndAt}
		Quie={GetAllQuizes}
	/>
)}


{eventState === "ENDED" && (
	<EventClosedRoom
		Title={event.eventTitle}
		Description={event.eventDescription}
		StartAt={event.eventScheduledStartAt}
		EndAt={event.eventScheduledEndAt}
	/>
)}
