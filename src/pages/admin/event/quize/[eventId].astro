---
export const prerender = false
import TwoColumnLayout from "@layouts/TwoColumnLayout.astro"
import QuizeEntry from "@components/QuizeEntry.astro";
import { getDb, siteSchema  } from "@db/index";
import { generateId } from "@utils/MainUtils";
import { and, eq, isNull } from "drizzle-orm";

const db = getDb()

const { eventId } = Astro.params;

if (!eventId) {
  return Astro.redirect("/admin/event");
}

const event = await db.select()
  .from(siteSchema.event)
	.where(
		and(
			eq(siteSchema.event.eventId, eventId),
			isNull(siteSchema.event.eventDeletedAt)
		))
  .then(res => res[0]);

if (!event) {
  return Astro.redirect("/admin/event");
}


const GetAllQuizes = await db.query.question.findMany({
	where:(and(
		eq(siteSchema.question.eventId, eventId),
		isNull(siteSchema.question.questionDeletedAt)
	)),
  with: {
    options: true
  }
});




if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();

	const action = formData.get("action") as string;
	const questionTitle = formData.get("questionTitle") as string;
	const questionId = formData.get("questionId") as string;
	const questionDescription = formData.get("questionDescription") as string;
	const questionType = formData.get("questionType") as "checkbox" | "radio";

	type OptionInput = {
		text: string;
		isCorrect: boolean;
	};

	const optionObject = JSON.parse(
		formData.get("optionObject") as string
	) as OptionInput[];

	if (action === "create") {

		const questionId : string = generateId();
		
		await db.insert(siteSchema.question).values({
			questionId,
			questionlabel: "Question label",
			questionCreatedAt: new Date().toISOString(),
			questionTitle,
			questionDescription,
			questionType,
			questionIsRequired: true,
			questionIsCollapsed: false,
			eventId: eventId,
		});

		await db.insert(siteSchema.option).values(
			optionObject.map((option, index) => ({
				optionId: generateId(),
				optionCreatedAt: new Date().toISOString(),
				optionTitle: option.text,
				optionKey: option.isCorrect,
				optionlabel: "",
				optionOrder: index + 1,
				questionId,
			}))
		);

		return Astro.redirect("/admin/event/quize/" + eventId + "?submitted=1");

	} 

	if (action === "update"){

		await db.update(siteSchema.question).set({
			questionUpdatedAt: new Date().toISOString(),
			questionTitle: questionTitle,
			questionDescription: questionDescription,
			questionType: questionType
		}).where(
			and(
				eq(siteSchema.question.questionId,questionId),
				isNull(siteSchema.question.questionDeletedAt)
			)
		)
	  await db.delete(siteSchema.option).where(
			eq(siteSchema.option.questionId, questionId)
    );
		await db.insert(siteSchema.option).values(
			optionObject.map((option, index) => ({
				optionId: generateId(),
				optionUpdatedAt: new Date().toISOString(),
				optionTitle: option.text,
				optionKey: option.isCorrect,
				optionlabel: "",
				optionOrder: index + 1,
				questionId,
			}))
    );

		return Astro.redirect("/admin/event/quize/" + eventId + "?updated=1");
		

	}


	if (action == "delete"){

		await db.update(siteSchema.question).set({
			questionDeletedAt: new Date().toISOString(),
		}).where(
			and(
				eq(siteSchema.question.questionId,questionId),
				isNull(siteSchema.question.questionDeletedAt)
			)
		)
		return Astro.redirect("/admin/event/quize/" + eventId + "?deleted=1");
	}



}


---

<TwoColumnLayout title={"quize | " + event.eventTitle}>

	<div slot="max-slot" class="h-full"> 

		<div class="border-2 border-primary bg-secondary h-full rounded-xl p-4  flex flex-col items-center">
			<h1 class="text-xl font-bold items-center">All Quie</h1>
			<div class=" border-b-2 border-primary w-full mt-2"></div>
			<div class="w-full p-8 mt-4 flex flex-col gap-6 overflow-y-auto">

				<!-- entry -->

				{(GetAllQuizes ?? []).map((quize, Index) => (
					<QuizeEntry
						Id={quize.questionId || ""}
						number={Index + 1}
						title={quize.questionTitle || ""}
						description={quize.questionDescription || ""}
						options={(quize.options ?? []).map(option => ({
							text: option.optionTitle || "",
							value: option.optionlabel || "",
							name: quize.questionId,
							key: option.optionKey
						}))}
						type={quize.questionType || "checkbox"}
						hideDescription={true}
					/>
				))}



			</div>

		</div>


	</div>


	
	<div slot="min-slot" class="h-full">
		<div class="border-2 border-primary bg-secondary h-full rounded-xl p-4 flex flex-col items-center">
			<h1 class="text-xl font-bold items-center">Quiz create</h1>
			<div class="border-b-2 border-primary w-full mt-2"></div>
			<form id="quizForm" method="post" class="flex flex-col w-full mt-2 px-4 h-full lg:overflow-y-auto">
				<input type="hidden" name="optionObject" id="AllOptions">
				<input type="hidden" name="action" id="action" value="create">
				<input type="hidden" name="questionId" id="questionId" value="">

				<h3 class="text-lg font-semibold mt-2">Question Title</h3>
				<input
					type="text"
					name="questionTitle"
					class="w-full mt-2 p-3 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
					placeholder="Type your title here..." required />

				<h3 class="text-lg font-semibold mt-2">Question Description</h3>
				<textarea 
					name="questionDescription"
					rows="4"
					class="w-full min-h-[12%] mt-2 p-3 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
					placeholder="Type your description here..." required></textarea>

				<h3 class="text-lg font-semibold mt-2">Question Type</h3>
				<select name="questionType" id="questionTypeField" class="mt-2 w-full border-2 border-primary bg-tertiary rounded-lg p-3 text-secondary focus:outline-none focus:ring-2 bg-primary">
					<option class="" value="default" disabled selected hidden>Select Type</option>
					<option value="radio">Single Option (Radio)</option>
					<option value="checkbox">Multiple Option (Checkbox)</option>
				</select>

				<h3 class="text-lg font-semibold mt-2">Question Options</h3>
				<div id="optionsContainer" class="flex flex-col w-full mt-2 gap-2">
					<!-- Options will be added here dynamically -->
				</div>

				<div class="flex flex-row gap-3 mt-2">
					<input
						type="text"
						id="newOptionInput"
						class="w-full p-4 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-base text-secondary placeholder:text-muted"
						placeholder="Type text or paste options here..." />

					<button type="button" id="addOptionBtn" class="border-2 bg-tertiary px-4 py-3 border-primary text-base rounded-lg whitespace-nowrap flex flex-row gap-2 items-center hover:hover-primary">
						<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<circle cx="12" cy="12" r="2"/>
							<line x1="12" y1="5" x2="12" y2="19" />
							<line x1="5" y1="12" x2="19" y2="12" />
						</svg>
						<span class="text-base">Add</span>
					</button>
				</div>


					<button
						id="SubmitQuestionEntry"
						type="submit"
						class="w-full p-3 mt-3 rounded-lg bg-accent text-white font-semibold hover:opacity-90 transition"
					>
						Set Question
					</button>


			</form>
		</div>
		
		<script >

			const addBtn = document.getElementById('addOptionBtn') as HTMLButtonElement;
			const newOptionInput = document.getElementById('newOptionInput') as HTMLInputElement;
			const optionsContainer = document.getElementById('optionsContainer')  as HTMLDivElement;
			const questionTypeField = document.getElementById('questionTypeField') as HTMLSelectElement;
			const quizForm = document.getElementById('quizForm') as HTMLFormElement;

			if (!addBtn || !newOptionInput || !optionsContainer || !questionTypeField || !quizForm) {
				console.error('Required elements not found');
				throw new Error('Required elements not found');
			}

			interface Option {
				id: number;
				text: string;
				isCorrect: boolean;
			}

			let optionCounter = 0;
			let allOptions: Option[] = []; 

			function createOptionElement(text : string, inputType: string) {
				const optionId = optionCounter++;
				const optionDiv = document.createElement('div');
				optionDiv.className = 'flex flex-row w-full';
				optionDiv.dataset.optionId = String(optionId);

				optionDiv.innerHTML = `
					<div class="flex flex-row p-3 items-center justify-between w-full border-2 border-primary rounded-lg cursor-pointer hover:hover-primary">
						<label class="flex items-center cursor-pointer">
							<input 
								type="${inputType}" 
								name="correctAnswer" 
								value="${optionId}"
								class="w-4 h-4 text-accent text-2xl scale-150 ml-2 cursor-pointer"
							>
							<span class="ml-3 text-xl text-secondary">${text}</span>
						</label>

						<button type="button" class="delete-btn flex flex-row whitespace-normal justify-between hover:text-red-400">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<polyline points="3 6 5 6 21 6"/>
								<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
								<line x1="10" y1="11" x2="10" y2="17"/>
								<line x1="14" y1="11" x2="14" y2="17"/>
							</svg>
						</button>
					</div>
				`;

				const deleteBtn = optionDiv.querySelector('.delete-btn');
				if (deleteBtn) {
					deleteBtn.addEventListener('click', () => {
						allOptions = allOptions.filter(opt => opt.id !== optionId);
						optionDiv.remove();
					});
				}

				return optionDiv;
			}

			function updateAllOptionTypes() {
				if (!questionTypeField || !optionsContainer) return;
				
				const selectedType = questionTypeField.value;
				if (selectedType === 'default') return;

				const allInputs = optionsContainer.querySelectorAll('input[name="correctAnswer"]');
				allInputs.forEach(input => {
					if (input instanceof HTMLInputElement) {
						input.type = selectedType;
						if (selectedType === 'radio') {
							input.checked = false; 
						}
					}
				});
			}

			addBtn.addEventListener('click', () => {
				if (!newOptionInput || !questionTypeField || !optionsContainer) return;
				
				const optionText = newOptionInput.value.trim();
				
				if (!optionText) {
					alert('Please enter option text');
					return;
				}

				const questionType = questionTypeField.value;
				if (questionType === 'default') {
					alert('Please select a question type first');
					return;
				}

				const optionId = optionCounter;
				const newOption = createOptionElement(optionText, questionType);
				optionsContainer.appendChild(newOption);

				allOptions.push({
					id: optionId,
					text: optionText,
					isCorrect: false
				});

				newOptionInput.value = '';
				newOptionInput.focus();
			});

			newOptionInput.addEventListener('keypress', (e) => {
				if (e.key === 'Enter' && addBtn) {
					e.preventDefault();
					addBtn.click();
				}
			});
			newOptionInput.addEventListener('paste', (e: ClipboardEvent) => {
				e.preventDefault();

				if (!questionTypeField || !optionsContainer) return;

				const questionType = questionTypeField.value;
				if (questionType === 'default') {
					alert('Please select a question type first');
					return;
				}

				const clipboardText = e.clipboardData?.getData('text');
				if (!clipboardText) return;

				const lines = clipboardText
					.split(/\r?\n/)
					.filter(Boolean);

				if (lines.length === 0) return;

				lines.forEach(text => {
					const optionId = optionCounter;
					const optionElement = createOptionElement(text, questionType);
					optionsContainer.appendChild(optionElement);

					allOptions.push({
						id: optionId,
						text,
						isCorrect: false
					});
				});

				newOptionInput.value = '';
				newOptionInput.focus();
			});


			questionTypeField.addEventListener('change', updateAllOptionTypes);

			quizForm.addEventListener('submit', (e) => {
			e.preventDefault();

			if (allOptions.length === 0) {
					alert('Please add at least one option');
					return;
			}

			const checkedInputs = document.querySelectorAll('input[name="correctAnswer"]:checked');
			if (checkedInputs.length === 0) {
					alert('Please select at least one correct answer');
					return;
			}


			const correctAnswerIds = Array.from(checkedInputs).map(input => 
				parseInt((input as HTMLInputElement).value)
			);

			allOptions.forEach(option => {
					option.isCorrect = correctAnswerIds.includes(option.id);
			});


			const allOptionsData = allOptions.map(option => ({
				text: option.text,
				isCorrect: option.isCorrect,

			}))

			const allOptionsInput = document.getElementById('AllOptions') as HTMLInputElement;
			allOptionsInput.value = JSON.stringify(allOptionsData);

			quizForm.submit();
	});

	document.addEventListener('DOMContentLoaded', () => {
		const editButtons = document.querySelectorAll('[data-title]');
		
		editButtons.forEach(button => {
			button.addEventListener('click', (e) => {
				const target = e.currentTarget as HTMLElement;
				
				const title = target.dataset.title || '';
				const description = target.dataset.description || '';
				const type = target.dataset.type || 'radio';
				const optionsJson = target.dataset.options || '[]';
				const questionId = target.dataset.id || '';
				
				let options: Array<{text: string, key: boolean}> = [];
				try {
						options = JSON.parse(optionsJson);
				} catch (error) {
						console.error('Error parsing options:', error);
						return;
				}
				
				const questionTitleInput = document.querySelector('input[name="questionTitle"]') as HTMLInputElement;
				const questionDescInput = document.querySelector('textarea[name="questionDescription"]') as HTMLTextAreaElement;
				const questionTypeSelect = document.getElementById('questionTypeField') as HTMLSelectElement;
				const questionIdInput = document.getElementById('questionId') as HTMLInputElement;
				
				if (questionTitleInput) questionTitleInput.value = title;
				if (questionDescInput) questionDescInput.value = description;
				if (questionTypeSelect) questionTypeSelect.value = type;
				if (questionIdInput) questionIdInput.value = questionId;
				
				if (optionsContainer) {
						optionsContainer.innerHTML = '';
				}
				allOptions = [];
				optionCounter = 0;
				
				options.forEach(option => {
						const optionId = optionCounter;
						
						const optionElement = createOptionElement(option.text, type);
						
						if (optionsContainer) {
								optionsContainer.appendChild(optionElement);
						}
						
						allOptions.push({
								id: optionId,
								text: option.text,
								isCorrect: option.key
						});
						
						if (option.key) {
								setTimeout(() => {
										const input = optionsContainer?.querySelector(`input[value="${optionId}"]`) as HTMLInputElement;
										if (input) {
												input.checked = true;
										}
								}, 10);
						}
				});
				
				const actionInput = document.getElementById('action') as HTMLInputElement;
				const submitButton = document.getElementById('SubmitQuestionEntry') as HTMLButtonElement;
				
				if (actionInput) actionInput.value = 'update';
				if (submitButton) submitButton.textContent = 'Update Question';
				
				const formContainer = document.querySelector('[slot="min-slot"]');
				if (formContainer) {
						formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
				}
			});
		});
	});

		</script>

	</div>

</TwoColumnLayout>
