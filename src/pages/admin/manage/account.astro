---
export const prerender = false
import BaseLayout from "@layouts/BaseLayout.astro";

import { generateId } from "@utils/MainUtils";
import { getDb } from "@db/index";
import { account, accountToken, user } from "@db/schema";
import {  eq, gt, isNull, sql } from "drizzle-orm";


import ToggleInput from '@components/ToggleInput.astro';
import RolePicker from '@components/RolePicker.astro';
import { friendlyDateMessage } from "@utils/TimeUtils";

const db = getDb()

const accounts = db.select()
	.from(account)
	.leftJoin(user, eq(account.userPayroll, user.userPayroll))
	.where(isNull(account.accountDeletedAt)).all()


if (Astro.request.method === "POST") {
	const formData = await Astro.request.formData();
	const action = formData.get("action") as string;
	const userId = formData.get("userId") as string;

	if (action === "create") {

		const oneTimeToken = generateId() + generateId()
		const validity = 30 * 60 * 1000; // 30 min
		const expiresAt = new Date(Date.now() + validity).toISOString();

		await db.insert(accountToken).values({
			accountTokenHash: oneTimeToken,
			accountTokenAction: "create",
			accountUserRefrence: generateId(),
			accountTokenExpireAt: expiresAt,
		}).returning();

		return Astro.redirect(`/account/create/${oneTimeToken}`);

	} 


	if (action === "reset") {

		const oneTimeToken = generateId() + generateId()
		const validity = 30 * 60 * 1000; // 30 min
		const expiresAt = new Date(Date.now() + validity).toISOString();

		await db.insert(accountToken).values({
			accountTokenHash: oneTimeToken,
			accountTokenAction: "reset",
			accountUserRefrence: userId,
			accountTokenExpireAt: expiresAt,
		}).returning();

		return Astro.redirect(`/account/reset/${oneTimeToken}`);

	} 


	if (action === "delete") {
		console.log("deletion request for", formData)

		await db.update(account)
		.set({
			accountDeletedAt: new Date().toISOString()
		}).where(eq(account.accountId, userId ))

		return Astro.redirect("/admin/manage/account?deleted=1");
	}


	if (action === "toggleStatus") {

		await db.update(account)
			.set({
				accountIsActive: sql`NOT ${account.accountIsActive}`
			}).where(eq(account.accountId, userId ))

		return Astro.redirect("/admin/manage/account?toggleStatus=1");
	}


}


const allgroups: string[] =  ["Admin", "Health", "HR Human Resource", "Safety", "Training"];
const accountTokens = db.select().from(accountToken)
    .where(
			gt(accountToken.accountTokenExpireAt, new Date().toISOString())
    ).all();


const createCount = accountTokens.filter(t => t.accountTokenAction === 'create').length;
const resetCount = accountTokens.filter(t => t.accountTokenAction === 'reset').length;


---

<BaseLayout title="Manage Account">

	<div class="w-full px-[3%] overflow-auto h-full">
		<div class="flex flex-col bg-secondary border-2 border-primary rounded-lg h-full px-8 py-2 items-center ">
			<h1 class="text-xl font-bold items-center">Manage Account</h1>
			<div class="border-b-2 border-primary w-full mt-2"></div>

			<div class="w-full overflow-x-auto">

				<div class="flex flex-row gap-2 items-center w-full justify-end px-4 py-2  ">

					{ resetCount > 0 &&
						<div class="status-indicator-error border-2 px-4 py-1 rounded-lg">Reset Request { resetCount } </div>
					}

					{ createCount > 0 &&
						<div class="status-indicator-accent border-2 px-4 py-1 rounded-lg">Creation Request { createCount } </div>
					}

					<form method="post">
						<input type="hidden" name="action" value="create" />
						<button type="submit" class="bg-(--color-button-accent) hover-overlay active-overlay px-4 py-1 rounded-lg text-white text-lg whitespace-nowrap border-2 border-primary">Create Account</button>
					</form>
				</div>

				<div class="border-b-2 border-primary w-full "></div>

				<!-- <table class="table-auto w-full border-collapse min-w-max mt-2"> -->
				<!-- 	<thead> -->
				<!-- 		<tr class="hover-overlay border-2 border-primary bg-tertiary"> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Sno</th> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Account Id</th> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">User Name</th> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Payroll</th> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Is Active</th> -->
				<!-- 			<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Created At</th> -->
				<!-- 		</tr> -->
				<!-- 	</thead> -->
				<!-- 	<tbody> -->
				<!-- 			<tr class="border-2 border-primary hover-overlay"> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{"1"}</td> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{"qrreg5bf8zdsk1guytxu9m8oc"}</td> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{"testuser1"}</td> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{"92004321"}</td> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap"><ToggleInput name={"sd"} checked={false} /></td> -->
				<!-- 				<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{"Sat, Jan 10, 2026, 5:16 PM"}</td> -->
				<!-- 			</tr> -->
				<!-- 	</tbody> -->
				<!-- </table> -->
			</div>


			<div class="overflow-scroll w-full mt-4">

				<div class="overflow-x-auto">
					<table class="table-auto w-full border-collapse min-w-max">
						<thead>
							<tr class="hover-overlay border-2 border-primary bg-tertiary">
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Sno</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Payroll</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Name</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Department</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Username</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Is Active</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Created At</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Updated At</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Group</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Password</th>
								<th class="px-4 py-2 text-left font-semibold whitespace-nowrap">Account</th>
							</tr>
						</thead>
						<tbody>
							{accounts.map((entry, index) => 
								<tr class="border-2 border-primary hover-overlay">
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{index + 1}</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{entry.account.userPayroll || "Missing"}</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{entry.user?.userName || "Missing"}</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{entry.user?.userDepartment || "Missing"}</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">{entry.account.accountUserName || "Some User"}</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">

									{entry.account.accountId ?
										<form method="post">
											<input type="hidden" name="action" value="toggleStatus" />
											<input type="hidden" name="userId" value={entry.account.accountId} />
										<!-- do submit -->
										<ToggleInput
											name={entry.account.accountId}
											checked={entry.account.accountIsActive}
											onclick={`return confirm('Are you sure you want to ${entry.account.accountIsActive ? 'disable' : 'enable'} this account?') && this.form.submit()`}
										/>
										</form> :

									<ToggleInput name={""} checked={entry.account.accountIsActive || false} disabled={true} />

									}
									</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">
										{entry.account.accountCreatedAt ? friendlyDateMessage(entry.account.accountCreatedAt) : ""}
									</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">
										{entry.account.accountUpdatedAt ? friendlyDateMessage(entry.account.accountUpdatedAt) : ""}
									</td>
									<td class="px-4 py-2 text-base text-primary whitespace-nowrap">
										<RolePicker groupsList={allgroups}/>
									</td>
									<td class=" p-1 ">
									{entry.account.accountId ?
										<form method="post">
											<input type="hidden" name="action" value="reset" />
											<input type="hidden" name="userId" value={entry.account.accountId} />
											<button type="submit" class="bg-(--color-button-warning) hover-overlay active-overlay px-4 py-1 rounded-lg text-white text-lg whitespace-nowrap border-2 border-primary ">Reset</button>
										</form> :

										<button type="submit" class="bg-(--color-button-warning) hover-overlay active-overlay px-4 py-1 rounded-lg text-white text-lg whitespace-nowrap border-2 border-primary ">Unavailable</button>

									}
									</td>


									<td class=" p-1 ">
									{entry.account.accountId ?
										<form method="post"
											onsubmit="return confirm('Are you sure you want to delete the account')"
										>
											<input type="hidden" name="action" value="delete" />
											<input type="hidden" name="userId" value={entry.account.accountId} />
											<button type="submit" class="bg-(--color-button-error) hover-overlay active-overlay px-4 py-1 rounded-lg text-white text-lg whitespace-nowrap border-2 border-primary ">Delete</button>
										</form> :

										<button type="reset" class="bg-(--color-button-warning) hover-overlay active-overlay px-4 py-1 rounded-lg text-white text-lg whitespace-nowrap border-2 border-primary ">Unavailable</button>

									}
									</td>
								</tr>
							)}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>


	<div class="flex flex-col bg-secondary border-2 border-primary rounded-lg h-full px-8 py-4 items-center overflow-x-auto" style="display: none;">
		<h1 class="text-xl font-bold items-center">Add User</h1>
		<div class="border-b-2 border-primary w-full mt-2"></div>
			<form method="post" class="flex flex-col w-full mt-2 px-2 h-full">
				<input type="hidden" name="userId" >
				<input type="hidden" name="action" value="create">

				<h3 class="text-lg font-semibold mt-2">User Name</h3>
				<input
					type="text"
					name="userName"
					class="w-full mt-2 p-3 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-lg text-secondary placeholder:text-muted"
					placeholder="Type your title here..." required />

				<h3 class="text-lg font-semibold mt-2">User Password</h3>
				<input
					type="text"
					name="userHash"
					class="w-full mt-2 p-3 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-lg text-secondary placeholder:text-muted"
					placeholder="Type your title here..." required />

				<h3 class="text-lg font-semibold mt-2">User Description</h3>

				<textarea 
					name="userDescription"
					rows="4"
					class="w-full min-h-[14%] mt-2 p-3 border-2 border-primary bg-tertiary rounded-lg focus:ring-2 focus:ring-accent focus:outline-none text-lg text-secondary placeholder:text-muted"
					placeholder="Type your answer here..." required></textarea>

				<h3 class="text-lg font-semibold mt-2 mb-2">User Group</h3>
				<!-- <RolePicker groupsList={allgroups}/> -->

				<button
					id="doEntry"
					type="submit"
					class="w-full p-3 min-h-12 mt-4 rounded-lg  font-bold button-accent text-white active-overlay hover-overlay transition"
				>
					Create
				</button>

			</form>

	</div>
</BaseLayout>
